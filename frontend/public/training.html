<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIA v3.0 - Personal Training Plan</title>
    
    <!-- Bootstrap 5.3.2 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Custom styles -->
    <link href="../src/styles/main.css" rel="stylesheet">
    
    <style>
        /* KISS: Simple markdown styling */
        .slide-content h1, .slide-content h2, .slide-content h3 {
            color: #0d6efd;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
        .slide-content h1 { font-size: 1.75rem; }
        .slide-content h2 { font-size: 1.5rem; }
        .slide-content h3 { font-size: 1.25rem; }
        .slide-content ul, .slide-content ol {
            margin-bottom: 1rem;
        }
        .slide-content li {
            margin-bottom: 0.5rem;
        }
        .slide-content blockquote {
            background: #f8f9fa;
            border-left: 4px solid #0d6efd;
            padding: 1rem;
            margin: 1rem 0;
        }
        .slide-content code {
            background: #f8f9fa;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-size: 0.9em;
        }
        .slide-content pre {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
        }
    </style>
</head>
<body class="bg-light">
    
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">
                <i class="bi bi-mortarboard me-2"></i>FIA v3.0
            </a>
            <span class="navbar-text text-white-50">
                <i class="bi bi-person-circle me-1"></i>
                <span id="learner-email">Loading...</span>
            </span>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container my-4">
        <div id="main-content">
            <!-- Content will be loaded dynamically -->
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Marked.js for markdown parsing (KISS solution) -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    
    <script>
        class TrainingApp {
            constructor() {
                this.container = document.getElementById('main-content');
                this.token = this.getTokenFromURL();
                this.sessionData = null;
                this.learnerSession = null;
                
                if (!this.token) {
                    this.showError('No session token provided');
                    return;
                }
                
                this.init();
            }
            
            getTokenFromURL() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('token');
            }
            
            async init() {
                try {
                    console.log('ğŸš€ Initializing TrainingApp with token:', this.token);
                    await this.loadLearnerData();
                    await this.displayTrainingPlan();
                } catch (error) {
                    console.error('Training app initialization error:', error);
                    this.showError(error.message);
                }
            }
            
            async loadLearnerData() {
                try {
                    console.log('ğŸ” Loading learner data for token:', this.token);
                    
                    // Validate session token first
                    const sessionResponse = await fetch(`/api/session/${this.token}`);
                    if (!sessionResponse.ok) {
                        throw new Error('Invalid or expired session token');
                    }
                    
                    const sessionData = await sessionResponse.json();
                    console.log('âœ… Session data loaded:', sessionData);
                    
                    this.sessionData = sessionData;
                    this.learnerSession = sessionData.learner_session;
                    
                    // Update UI with learner info
                    if (this.learnerSession) {
                        document.getElementById('learner-email').textContent = this.learnerSession.email || 'Your Training Session';
                    }
                    
                } catch (error) {
                    console.error('âŒ Error loading learner data:', error);
                    throw new Error(`Failed to load training data: ${error.message}`);
                }
            }
            
            async displayTrainingPlan() {
                // Afficher le loading d'abord
                this.showLoading();
                
                try {
                    console.log('ğŸš€ Starting training plan generation...');
                    
                    // VÃ©rifier qu'on a les donnÃ©es nÃ©cessaires
                    if (!this.learnerSession) {
                        console.log('âš ï¸ No learner session data available, redirecting to profile page...');
                        // Rediriger vers la page de profil si pas de donnÃ©es learner
                        window.location.href = `/frontend/public/session.html?token=${this.token}`;
                        return;
                    }
                    
                    if (!this.sessionData?.training_session?.training_id) {
                        throw new Error('No training ID available');
                    }
                    
                    // PrÃ©parer la requÃªte de gÃ©nÃ©ration de plan
                    const planRequest = {
                        training_id: this.sessionData.training_session.training_id,
                        learner_session_id: this.learnerSession.id,
                        learner_profile: {
                            experience_level: this.learnerSession.experience_level,
                            learning_style: this.learnerSession.learning_style,
                            job_position: this.learnerSession.job_position,
                            activity_sector: this.learnerSession.activity_sector,
                            country: this.learnerSession.country,
                            language: this.learnerSession.language
                        },
                        force_regenerate: false
                    };
                    
                    console.log('ğŸ“ Plan generation request:', planRequest);
                    
                    // Appeler l'API de gÃ©nÃ©ration de plans intÃ©grÃ©e
                    console.log('ğŸ”„ Calling /api/generate-plan-integrated...');
                    const planResponse = await fetch('/api/generate-plan-integrated', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(planRequest)
                    });
                    
                    console.log('ğŸ“Š Plan response status:', planResponse.status);
                    console.log('ğŸ“Š Plan response headers:', [...planResponse.headers.entries()]);
                    
                    if (!planResponse.ok) {
                        const errorText = await planResponse.text();
                        console.error('âŒ Plan generation failed - Raw response:', errorText);
                        
                        let errorData;
                        try {
                            errorData = JSON.parse(errorText);
                        } catch (e) {
                            errorData = { detail: { error_message: errorText } };
                        }
                        
                        console.error('âŒ Plan generation failed:', errorData);
                        throw new Error(`Plan generation failed: ${errorData.detail?.error_message || planResponse.statusText}`);
                    }
                    
                    const planData = await planResponse.json();
                    console.log('âœ… Plan generated successfully:', planData);
                    
                    // Afficher le plan gÃ©nÃ©rÃ©
                    this.renderGeneratedPlan(planData);
                    
                } catch (error) {
                    console.error('âŒ Error generating training plan:', error);
                    this.showError(`Failed to generate training plan: ${error.message}`);
                }
            }
            
            showLoading() {
                this.container.innerHTML = `
                    <div class="row">
                        <div class="col-12">
                            <div class="card shadow-sm">
                                <div class="card-body text-center py-5">
                                    <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <h5 class="card-title">Generating Your Personalized Training Plan</h5>
                                    <p class="card-text text-muted">
                                        Our AI is analyzing your profile and creating a customized learning experience...
                                        <br>This may take a few moments.
                                    </p>
                                    <div class="progress mt-3" style="height: 6px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                             role="progressbar" style="width: 100%"></div>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <small class="text-muted">
                                            <strong>Debug Info:</strong><br>
                                            Session Token: ${this.token}<br>
                                            Training ID: ${this.sessionData?.training_session?.training_id || 'Loading...'}<br>
                                            Learner Email: ${this.learnerSession?.email || 'Loading...'}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            renderGeneratedPlan(planData) {
                console.log('ğŸ¨ Rendering generated plan:', planData);
                
                const trainingPlan = planData.training_plan;
                const metadata = planData.generation_metadata;
                
                let accordionHTML = '';
                trainingPlan.stages.forEach((stage, stageIndex) => {
                    let modulesHTML = '';
                    stage.modules.forEach((module, moduleIndex) => {
                        let submodulesHTML = '';
                        module.submodules.forEach((submodule, submoduleIndex) => {
                            submodulesHTML += `
                                <div class="col-md-6 mb-2">
                                    <div class="card border-light bg-light">
                                        <div class="card-body p-3">
                                            <h6 class="card-title text-primary">${submodule.submodule_name}</h6>
                                            <span class="badge bg-secondary">${submodule.slide_count} slides</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        modulesHTML += `
                            <div class="mb-3">
                                <h6 class="text-dark">${module.module_name}</h6>
                                <div class="row">${submodulesHTML}</div>
                            </div>
                        `;
                    });
                    
                    const isFirstStage = stageIndex === 0;
                    accordionHTML += `
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button ${isFirstStage ? '' : 'collapsed'}" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#stage${stage.stage_number}">
                                    <i class="bi bi-mortarboard me-2 text-primary"></i>
                                    Ã‰tape ${stage.stage_number}: ${stage.stage_name}
                                </button>
                            </h2>
                            <div id="stage${stage.stage_number}" class="accordion-collapse collapse ${isFirstStage ? 'show' : ''}">
                                <div class="accordion-body">
                                    ${modulesHTML}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                this.container.innerHTML = `
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card shadow-sm">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-book me-2"></i>Your Personalized Training Plan
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-success">
                                        <i class="bi bi-check-circle me-2"></i>
                                        <strong>Success!</strong> ${planData.message}
                                        <br><small class="text-muted">Method: ${metadata.generation_method} | 
                                        Plan ID: ${metadata.database_integration?.plan_id || 'N/A'}</small>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-3">
                                            <div class="text-center">
                                                <div class="h4 text-primary">${metadata.total_stages}</div>
                                                <small class="text-muted">Stages</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center">
                                                <div class="h4 text-info">${metadata.total_modules}</div>
                                                <small class="text-muted">Modules</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center">
                                                <div class="h4 text-success">${metadata.total_slides}</div>
                                                <small class="text-muted">Slides</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="text-center">
                                                <div class="h4 text-warning">${metadata.database_integration?.generation_time_seconds || 0}s</div>
                                                <small class="text-muted">Generation Time</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <h6 class="text-muted mb-3">Training Structure:</h6>
                                    <div class="accordion" id="trainingAccordion">
                                        ${accordionHTML}
                                    </div>
                                    
                                    <div class="mt-4">
                                        <button class="btn btn-primary me-2" id="start-training-btn">
                                            <i class="bi bi-play-circle me-1"></i>Start Training
                                        </button>
                                        <button class="btn btn-outline-secondary me-2">
                                            <i class="bi bi-download me-1"></i>Download Plan
                                        </button>
                                        <button class="btn btn-outline-info" onclick="location.reload()">
                                            <i class="bi bi-arrow-clockwise me-1"></i>Regenerate
                                        </button>
                                    </div>
                                    
                                    <!-- Debug Information -->
                                    <div class="mt-4">
                                        <details>
                                            <summary class="text-muted">Debug Information</summary>
                                            <pre class="bg-light p-3 mt-2 small">${JSON.stringify(metadata, null, 2)}</pre>
                                        </details>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <!-- AI Assistant Chat -->
                            <div class="card shadow-sm">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">
                                        <i class="bi bi-robot me-2"></i>AI Training Assistant
                                    </h6>
                                </div>
                                <div class="card-body" style="height: 400px; overflow-y: auto;">
                                    <div class="chat-messages">
                                        <div class="message assistant mb-3">
                                            <div class="d-flex align-items-start">
                                                <div class="avatar bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; font-size: 14px;">
                                                    AI
                                                </div>
                                                <div class="message-content">
                                                    <div class="bg-light p-3 rounded">
                                                        <p class="mb-0 small">Hello! I've just generated your personalized ${metadata.total_slides}-slide training plan with ${metadata.total_stages} stages. The plan was created using ${metadata.generation_method} and is now saved in our database. I'm here to help you throughout your learning journey!</p>
                                                    </div>
                                                    <small class="text-muted">Just now</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <div class="input-group">
                                        <input type="text" class="form-control" placeholder="Type your question...">
                                        <button class="btn btn-success" type="button">
                                            <i class="bi bi-send"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Progress Panel -->
                            <div class="card shadow-sm mt-3">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="bi bi-graph-up me-2"></i>Your Progress
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="small">Overall Progress</span>
                                        <span class="badge bg-primary">0%</span>
                                    </div>
                                    <div class="progress mb-3" style="height: 8px;">
                                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    
                                    <div class="small text-muted">
                                        <div class="d-flex justify-content-between">
                                            <span>Slides completed:</span>
                                            <span>0 / ${metadata.total_slides}</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>Time spent:</span>
                                            <span>0 min</span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>Current stage:</span>
                                            <span>${trainingPlan.stages[0]?.stage_name || 'Discovery'}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Ajouter l'event listener pour le bouton Start Training
                const startButton = document.getElementById('start-training-btn');
                if (startButton) {
                    startButton.addEventListener('click', () => this.startTraining());
                }
            }
            
            async startTraining() {
                try {
                    console.log('ğŸš€ Starting training for session:', this.learnerSession.id);
                    
                    // GÃ©nÃ©rer et afficher la premiÃ¨re slide
                    await this.generateAndDisplayFirstSlide();
                    
                } catch (error) {
                    console.error('âŒ Error starting training:', error);
                    this.showError(`Failed to start training: ${error.message}`);
                }
            }
            
            async generateAndDisplayFirstSlide() {
                try {
                    console.log('ğŸ¯ [API] === DÃ‰BUT GÃ‰NÃ‰RATION PREMIÃˆRE SLIDE ===');
                    console.log('ğŸ¯ [API] Session ID:', this.learnerSession.id);
                    
                    // Afficher loading pendant gÃ©nÃ©ration
                    this.showSlideLoading();
                    
                    // Appeler l'API pour gÃ©nÃ©rer la premiÃ¨re slide
                    console.log('ğŸ”„ [API] Appel API /api/slides/generate-first/${this.learnerSession.id}');
                    const response = await fetch(`/api/slides/generate-first/${this.learnerSession.id}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    console.log('ğŸ“¡ [API] RESPONSE STATUS:', response.status);
                    console.log('ğŸ“¡ [API] RESPONSE OK:', response.ok);
                    console.log('ğŸ“¡ [API] RESPONSE HEADERS:', [...response.headers.entries()]);
                    
                    if (!response.ok) {
                        console.log('âŒ [API] RESPONSE NOT OK - RÃ©cupÃ©ration erreur...');
                        const errorData = await response.json();
                        console.log('âŒ [API] ERROR DATA:', errorData);
                        throw new Error(errorData.detail || 'Failed to generate first slide');
                    }
                    
                    console.log('ğŸ”„ [API] Parsing JSON response...');
                    const slideData = await response.json();
                    console.log('âœ… [API] SLIDE DATA REÃ‡UE (COMPLET):', slideData);
                    console.log('âœ… [API] SLIDE DATA TYPE:', typeof slideData);
                    console.log('âœ… [API] SLIDE DATA KEYS:', Object.keys(slideData));
                    
                    if (slideData.data) {
                        console.log('ğŸ” [API] slideData.data TYPE:', typeof slideData.data);
                        console.log('ğŸ” [API] slideData.data KEYS:', Object.keys(slideData.data));
                        console.log('ğŸ” [API] slideData.data COMPLET:', slideData.data);
                        
                        if (slideData.data.title) {
                            console.log('ğŸ“‹ [API] TITRE DÃ‰TECTÃ‰:', slideData.data.title);
                        }
                        if (slideData.data.slide_content) {
                            console.log('ğŸ“‹ [API] SLIDE_CONTENT DÃ‰TECTÃ‰ (longueur):', slideData.data.slide_content.length);
                            console.log('ğŸ“‹ [API] SLIDE_CONTENT PREVIEW:', slideData.data.slide_content.substring(0, 150) + '...');
                        }
                        if (slideData.data.content) {
                            console.log('ğŸ“‹ [API] CONTENT DÃ‰TECTÃ‰ (longueur):', slideData.data.content.length);
                            console.log('ğŸ“‹ [API] CONTENT PREVIEW:', slideData.data.content.substring(0, 150) + '...');
                        }
                    } else {
                        console.log('âš ï¸ [API] PAS DE slideData.data - Structure diffÃ©rente?');
                        console.log('ğŸ” [API] Analyse structure alternative...');
                        if (slideData.title) {
                            console.log('ğŸ“‹ [API] TITRE DIRECT:', slideData.title);
                        }
                        if (slideData.slide_content) {
                            console.log('ğŸ“‹ [API] SLIDE_CONTENT DIRECT:', slideData.slide_content.substring(0, 150) + '...');
                        }
                    }
                    
                    console.log('ğŸ¨ [API] === PASSAGE Ã€ DISPLAYSLIDE ===');
                    // Afficher la slide - passer les bonnes donnÃ©es
                    this.displaySlideContent(slideData.data || slideData);
                    
                } catch (error) {
                    console.error('âŒ [API] ERROR generateAndDisplayFirstSlide:', error);
                    console.error('âŒ [API] ERROR STACK:', error.stack);
                    throw error;
                }
            }
            
            showSlideLoading() {
                this.container.innerHTML = `
                    <div class="row">
                        <div class="col-lg-9">
                            <div class="card shadow-sm">
                                <div class="card-body text-center py-5">
                                    <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <h5 class="card-title">Generating Your First Slide</h5>
                                    <p class="card-text text-muted">
                                        Our AI is creating personalized content based on your profile...
                                    </p>
                                    <div class="progress mt-3" style="height: 6px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                             role="progressbar" style="width: 100%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3">
                            <div class="card shadow-sm">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">
                                        <i class="bi bi-robot me-2"></i>AI Assistant
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <p class="small text-muted">AI assistant will be available once your first slide is ready.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            displaySlideContent(slideData) {
                console.log('ğŸ¨ [DISPLAY] === DÃ‰BUT ANALYSE DES DONNÃ‰ES ===');
                console.log('ğŸ¨ [DISPLAY] slideData TYPE:', typeof slideData);
                console.log('ğŸ¨ [DISPLAY] slideData COMPLET:', slideData);
                console.log('ğŸ¨ [DISPLAY] slideData.title:', slideData.title);
                console.log('ğŸ¨ [DISPLAY] slideData.slide_content:', slideData.slide_content);
                console.log('ğŸ¨ [DISPLAY] slideData.content:', slideData.content);
                console.log('ğŸ¨ [DISPLAY] slideData.slide:', slideData.slide);
                
                // KISS: Extract content directly from the data structure
                // slideData peut contenir slide_content (format JSON), content, ou slide.content
                let title, content;
                
                if (slideData.title && slideData.slide_content) {
                    // Structure avec slide_content (format JSON de l'API)
                    console.log('ğŸ¯ [DISPLAY] BRANCHE 1: title + slide_content dÃ©tectÃ©s');
                    title = slideData.title;
                    content = slideData.slide_content;
                    console.log('ğŸ¯ [DISPLAY] BRANCHE 1: title =', title);
                    console.log('ğŸ¯ [DISPLAY] BRANCHE 1: content =', content);
                } else if (slideData.title && slideData.content) {
                    // Structure directe
                    console.log('ğŸ¯ [DISPLAY] BRANCHE 2: title + content dÃ©tectÃ©s');
                    title = slideData.title;
                    content = slideData.content;
                    console.log('ğŸ¯ [DISPLAY] BRANCHE 2: title =', title);
                    console.log('ğŸ¯ [DISPLAY] BRANCHE 2: content =', content);
                } else if (slideData.slide) {
                    // Structure avec "slide" wrapper
                    console.log('ğŸ¯ [DISPLAY] BRANCHE 3: slide wrapper dÃ©tectÃ©');
                    title = slideData.slide.title;
                    content = slideData.slide.content || slideData.slide.slide_content;
                    console.log('ğŸ¯ [DISPLAY] BRANCHE 3: title =', title);
                    console.log('ğŸ¯ [DISPLAY] BRANCHE 3: content =', content);
                } else {
                    // Fallback
                    console.log('ğŸ¯ [DISPLAY] BRANCHE 4: FALLBACK utilisÃ©');
                    title = 'Formation Content';
                    content = slideData.slide_content || slideData.content || JSON.stringify(slideData);
                    console.log('ğŸ¯ [DISPLAY] BRANCHE 4: title =', title);
                    console.log('ğŸ¯ [DISPLAY] BRANCHE 4: content =', content);
                }
                
                console.log('ğŸ“ [DISPLAY] EXTRACTION FINALE:');
                console.log('ğŸ“ [DISPLAY] title FINAL =', title);
                console.log('ğŸ“ [DISPLAY] content FINAL (type):', typeof content);
                console.log('ğŸ“ [DISPLAY] content FINAL (longueur):', content ? content.length : 'NULL');
                console.log('ğŸ“ [DISPLAY] content FINAL (preview):', content ? content.substring(0, 100) + '...' : 'NULL');
                console.log('ğŸ¨ [DISPLAY] === AVANT PASSAGE Ã€ MARKDOWN ===');
                
                // Stocker le contenu markdown original pour les fonctionnalitÃ©s d'interaction
                this.currentSlideContent = content;
                console.log('ğŸ’¾ [DISPLAY] Current slide content stored for interactions');
                
                this.container.innerHTML = `
                    <div class="row">
                        <!-- Main slide content (75% width) -->
                        <div class="col-lg-9">
                            <div class="card shadow-sm">
                                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">
                                        <i class="bi bi-file-slides me-2"></i>${title}
                                    </h5>
                                    <div>
                                        <span class="badge bg-light text-dark">Slide ${slideData.order_in_submodule || 1}</span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Slide content in markdown format -->
                                    <div id="slide-content" class="slide-content">
                                        ${this.markdownToHtml(content)}
                                    </div>
                                    
                                    <!-- Navigation buttons -->
                                    <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                                        <button class="btn btn-outline-secondary" disabled>
                                            <i class="bi bi-arrow-left me-1"></i>Previous
                                        </button>
                                        <div class="btn-group">
                                            <button id="simplify-btn" class="btn btn-outline-primary">
                                                <i class="bi bi-lightbulb me-1"></i>Simplify
                                            </button>
                                            <button id="more-details-btn" class="btn btn-outline-info">
                                                <i class="bi bi-plus-circle me-1"></i>More Details
                                            </button>
                                            <button class="btn btn-outline-success">
                                                <i class="bi bi-pencil me-1"></i>Examples
                                            </button>
                                        </div>
                                        <button class="btn btn-primary">
                                            <i class="bi bi-arrow-right me-1"></i>Next
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Slide metadata -->
                            <div class="mt-3">
                                <small class="text-muted">
                                    Generated: ${slideData.generated_at ? new Date(slideData.generated_at).toLocaleString() : 'Just now'} |
                                    Slide ID: ${slideData.slide_id || 'N/A'}
                                </small>
                            </div>
                        </div>
                        
                        <!-- AI Chat sidebar (25% width) -->
                        <div class="col-lg-3">
                            <div class="card shadow-sm" style="height: 600px;">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">
                                        <i class="bi bi-robot me-2"></i>AI Training Assistant
                                    </h6>
                                </div>
                                <div class="card-body p-0" style="height: 500px; overflow-y: auto;" id="chat-messages">
                                    <div class="p-3">
                                        <div class="message assistant mb-3">
                                            <div class="d-flex align-items-start">
                                                <div class="avatar bg-success text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; font-size: 12px;">
                                                    AI
                                                </div>
                                                <div class="message-content">
                                                    <div class="bg-light p-2 rounded">
                                                        <p class="mb-0 small">Welcome! I'm here to help you with this slide. Feel free to ask questions about the content or request clarifications.</p>
                                                    </div>
                                                    <small class="text-muted">Just now</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer p-2">
                                    <div class="input-group input-group-sm">
                                        <input type="text" class="form-control" placeholder="Ask about this slide..." id="chat-input">
                                        <button class="btn btn-success" type="button" id="send-message-btn">
                                            <i class="bi bi-send"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Ajouter event listeners pour le chat
                this.setupChatFunctionality();
                this.setupSlideInteractionButtons();
            }
            
            markdownToHtml(markdown) {
                console.log('ğŸ“–ğŸ“–ğŸ“– [MARKDOWN] ============== DÃ‰BUT TRAITEMENT MARKDOWN ==============');
                console.log('ğŸ“–ğŸ“–ğŸ“– [MARKDOWN] markdown TYPE:', typeof markdown);
                console.log('ğŸ“–ğŸ“–ğŸ“– [MARKDOWN] markdown NULL/UNDEFINED?', markdown == null);
                console.log('ğŸ“–ğŸ“–ğŸ“– [MARKDOWN] markdown LONGUEUR:', markdown ? markdown.length : 'N/A');
                console.log('ğŸ“–ğŸ“–ğŸ“– [MARKDOWN] markdown IS STRING?:', typeof markdown === 'string');
                console.log('ğŸ“–ğŸ“–ğŸ“– [MARKDOWN] markdown PREVIEW (300 chars):');
                console.log('ğŸ“–ğŸ“–ğŸ“– [MARKDOWN] ---START PREVIEW---');
                console.log(markdown ? markdown.substring(0, 300) : 'NULL');
                console.log('ğŸ“–ğŸ“–ğŸ“– [MARKDOWN] ---END PREVIEW---');
                console.log('ğŸ“–ğŸ“–ğŸ“– [MARKDOWN] marked DISPONIBLE?:', typeof marked !== 'undefined');
                console.log('ğŸ“–ğŸ“–ğŸ“– [MARKDOWN] marked.parse DISPONIBLE?:', typeof marked?.parse === 'function');
                
                // Analyse dÃ©taillÃ©e du contenu
                if (markdown) {
                    console.log('ğŸ”ğŸ”ğŸ” [MARKDOWN] ANALYSE DÃ‰TAILLÃ‰E DU CONTENU:');
                    console.log('ğŸ”ğŸ”ğŸ” [MARKDOWN] Contient des # (titres)?', markdown.includes('#'));
                    console.log('ğŸ”ğŸ”ğŸ” [MARKDOWN] Contient des * (listes)?', markdown.includes('*'));
                    console.log('ğŸ”ğŸ”ğŸ” [MARKDOWN] Contient des | (tableaux)?', markdown.includes('|'));
                    console.log('ğŸ”ğŸ”ğŸ” [MARKDOWN] Contient des \\n (sauts de ligne)?', markdown.includes('\n'));
                    console.log('ğŸ”ğŸ”ğŸ” [MARKDOWN] Nombre de sauts de ligne:', (markdown.match(/\n/g) || []).length);
                    
                    // Afficher les premiÃ¨res et derniÃ¨res lignes
                    const lines = markdown.split('\n');
                    console.log('ğŸ”ğŸ”ğŸ” [MARKDOWN] Nombre total de lignes:', lines.length);
                    console.log('ğŸ”ğŸ”ğŸ” [MARKDOWN] PremiÃ¨res 5 lignes:');
                    lines.slice(0, 5).forEach((line, index) => {
                        console.log(`ğŸ”ğŸ”ğŸ” [MARKDOWN] Ligne ${index + 1}: "${line}"`);
                    });
                    
                    if (lines.length > 10) {
                        console.log('ğŸ”ğŸ”ğŸ” [MARKDOWN] ... (lignes intermÃ©diaires cachÃ©es) ...');
                        console.log('ğŸ”ğŸ”ğŸ” [MARKDOWN] DerniÃ¨res 3 lignes:');
                        lines.slice(-3).forEach((line, index) => {
                            console.log(`ğŸ”ğŸ”ğŸ” [MARKDOWN] Ligne ${lines.length - 3 + index + 1}: "${line}"`);
                        });
                    }
                }
                
                if (!markdown) {
                    console.log('âš ï¸âš ï¸âš ï¸ [MARKDOWN] CONTENU VIDE - Retour message par dÃ©faut');
                    const defaultHtml = '<p>Content is being generated...</p>';
                    console.log('ğŸ”„ğŸ”„ğŸ”„ [MARKDOWN] DEFAULT HTML:', defaultHtml);
                    return defaultHtml;
                }
                
                try {
                    console.log('ğŸ”„ğŸ”„ğŸ”„ [MARKDOWN] DÃ‰BUT PARSING avec marked.parse...');
                    console.log('ğŸ”„ğŸ”„ğŸ”„ [MARKDOWN] Input exact pour marked.parse:');
                    console.log('ğŸ”„ğŸ”„ğŸ”„ [MARKDOWN] ---START INPUT---');
                    console.log(markdown.substring(0, 500));
                    console.log('ğŸ”„ğŸ”„ğŸ”„ [MARKDOWN] ---END INPUT---');
                    
                    // KISS: Use marked.js for proper markdown parsing
                    const htmlResult = marked.parse(markdown);
                    
                    console.log('âœ…âœ…âœ… [MARKDOWN] PARSING RÃ‰USSI!');
                    console.log('ğŸ“ğŸ“ğŸ“ [MARKDOWN] HTML RÃ‰SULTAT TYPE:', typeof htmlResult);
                    console.log('ğŸ“ğŸ“ğŸ“ [MARKDOWN] HTML RÃ‰SULTAT LONGUEUR:', htmlResult ? htmlResult.length : 'N/A');
                    console.log('ğŸ“ğŸ“ğŸ“ [MARKDOWN] HTML RÃ‰SULTAT IS STRING?:', typeof htmlResult === 'string');
                    console.log('ğŸ“ğŸ“ğŸ“ [MARKDOWN] HTML RÃ‰SULTAT PREVIEW (400 chars):');
                    console.log('ğŸ“ğŸ“ğŸ“ [MARKDOWN] ---START HTML RESULT---');
                    console.log(htmlResult ? htmlResult.substring(0, 400) + '...' : 'NULL');
                    console.log('ğŸ“ğŸ“ğŸ“ [MARKDOWN] ---END HTML RESULT---');
                    
                    // Analyser le HTML gÃ©nÃ©rÃ©
                    if (htmlResult) {
                        console.log('ğŸ”ğŸ”ğŸ” [MARKDOWN] ANALYSE HTML GÃ‰NÃ‰RÃ‰:');
                        console.log('ğŸ”ğŸ”ğŸ” [MARKDOWN] Contient <h1>?', htmlResult.includes('<h1>'));
                        console.log('ğŸ”ğŸ”ğŸ” [MARKDOWN] Contient <h2>?', htmlResult.includes('<h2>'));
                        console.log('ğŸ”ğŸ”ğŸ” [MARKDOWN] Contient <ul>?', htmlResult.includes('<ul>'));
                        console.log('ğŸ”ğŸ”ğŸ” [MARKDOWN] Contient <table>?', htmlResult.includes('<table>'));
                        console.log('ğŸ”ğŸ”ğŸ” [MARKDOWN] Contient <p>?', htmlResult.includes('<p>'));
                        
                        // Compter les balises
                        const h1Count = (htmlResult.match(/<h1>/g) || []).length;
                        const h2Count = (htmlResult.match(/<h2>/g) || []).length;
                        const tableCount = (htmlResult.match(/<table>/g) || []).length;
                        const pCount = (htmlResult.match(/<p>/g) || []).length;
                        
                        console.log('ğŸ”ğŸ”ğŸ” [MARKDOWN] Nombre de <h1>:', h1Count);
                        console.log('ğŸ”ğŸ”ğŸ” [MARKDOWN] Nombre de <h2>:', h2Count);
                        console.log('ğŸ”ğŸ”ğŸ” [MARKDOWN] Nombre de <table>:', tableCount);
                        console.log('ğŸ”ğŸ”ğŸ” [MARKDOWN] Nombre de <p>:', pCount);
                    }
                    
                    console.log('ğŸ“–ğŸ“–ğŸ“– [MARKDOWN] ============== FIN TRAITEMENT MARKDOWN SUCCÃˆS ==============');
                    return htmlResult;
                    
                } catch (error) {
                    console.error('âŒâŒâŒ [MARKDOWN] ERREUR PARSING:', error);
                    console.error('âŒâŒâŒ [MARKDOWN] ERROR MESSAGE:', error.message);
                    console.error('âŒâŒâŒ [MARKDOWN] ERROR STACK:', error.stack);
                    console.log('ğŸ”„ğŸ”„ğŸ”„ [MARKDOWN] FALLBACK: Conversion simple \\n -> <br>');
                    
                    // Fallback to plain text with line breaks
                    const fallbackResult = markdown.replace(/\n/g, '<br>');
                    console.log('ğŸ“ğŸ“ğŸ“ [MARKDOWN] FALLBACK RÃ‰SULTAT LONGUEUR:', fallbackResult.length);
                    console.log('ğŸ“ğŸ“ğŸ“ [MARKDOWN] FALLBACK RÃ‰SULTAT PREVIEW (300 chars):', fallbackResult.substring(0, 300) + '...');
                    console.log('ğŸ“–ğŸ“–ğŸ“– [MARKDOWN] ============== FIN TRAITEMENT MARKDOWN FALLBACK ==============');
                    return fallbackResult;
                }
            }
            
            setupChatFunctionality() {
                const chatInput = document.getElementById('chat-input');
                const sendButton = document.getElementById('send-message-btn');
                const chatMessages = document.getElementById('chat-messages');
                
                if (chatInput && sendButton && chatMessages) {
                    const sendMessage = async () => {
                        const message = chatInput.value.trim();
                        if (!message) return;
                        
                        console.log('ğŸ’¬ [CHAT] Sending message:', message);
                        
                        // DÃ©sactiver l'input et le bouton pendant l'envoi
                        chatInput.disabled = true;
                        sendButton.disabled = true;
                        sendButton.innerHTML = '<i class="bi bi-hourglass-split"></i>';
                        
                        // Ajouter le message de l'utilisateur au chat
                        this.addChatMessage('user', message);
                        chatInput.value = '';
                        
                        try {
                            // PrÃ©parer la requÃªte chat
                            const chatRequest = {
                                message: message,
                                context: {
                                    training_id: this.sessionData.training_session.training_id,
                                    learner_session_id: this.learnerSession.id,
                                    current_slide_id: null, // TODO: Add current slide ID when available
                                    training_content: "Current slide content", // TODO: Get actual current slide content
                                    learner_profile: {
                                        experience_level: this.learnerSession.experience_level,
                                        learning_style: this.learnerSession.learning_style,
                                        job_position: this.learnerSession.job_position,
                                        activity_sector: this.learnerSession.activity_sector,
                                        country: this.learnerSession.country,
                                        language: this.learnerSession.language
                                    },
                                    conversation_history: this.getChatHistory()
                                },
                                conversation_type: "general"
                            };
                            
                            console.log('ğŸ“¤ [CHAT] Request payload:', chatRequest);
                            
                            // Appeler l'API chat
                            const response = await fetch('/api/chat', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(chatRequest)
                            });
                            
                            console.log('ğŸ“¥ [CHAT] Response status:', response.status);
                            console.log('ğŸ“¥ [CHAT] Response headers:', [...response.headers.entries()]);
                            
                            if (!response.ok) {
                                const errorData = await response.json();
                                console.error('âŒ [CHAT] Error response:', errorData);
                                throw new Error(errorData.detail || 'Chat service temporarily unavailable');
                            }
                            
                            const chatResponse = await response.json();
                            console.log('âœ… [CHAT] Success response:', chatResponse);
                            
                            // Ajouter la rÃ©ponse de l'IA au chat
                            this.addChatMessage('assistant', chatResponse.response, {
                                confidence: chatResponse.confidence_score,
                                suggested_actions: chatResponse.suggested_actions,
                                related_concepts: chatResponse.related_concepts
                            });
                            
                        } catch (error) {
                            console.error('âŒ [CHAT] Error:', error);
                            this.addChatMessage('assistant', 
                                `I'm sorry, I encountered an error. Please try again. (${error.message})`,
                                { error: true }
                            );
                        } finally {
                            // RÃ©activer l'input et le bouton
                            chatInput.disabled = false;
                            sendButton.disabled = false;
                            sendButton.innerHTML = '<i class="bi bi-send"></i>';
                            chatInput.focus();
                        }
                    };
                    
                    sendButton.addEventListener('click', sendMessage);
                    chatInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            sendMessage();
                        }
                    });
                }
            }
            
            addChatMessage(role, content, metadata = {}) {
                const chatMessages = document.getElementById('chat-messages');
                const timestamp = new Date().toLocaleTimeString();
                
                const isUser = role === 'user';
                const avatarBg = isUser ? 'bg-primary' : 'bg-success';
                const avatarText = isUser ? 'You' : 'AI';
                const messageClass = isUser ? 'justify-content-end' : '';
                const bubbleClass = isUser ? 'bg-primary text-white' : 'bg-light';
                
                const messageHtml = `
                    <div class="p-3">
                        <div class="message ${role} mb-3">
                            <div class="d-flex align-items-start ${messageClass}">
                                ${!isUser ? `<div class="avatar ${avatarBg} text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; font-size: 12px;">
                                    ${avatarText}
                                </div>` : ''}
                                <div class="message-content ${isUser ? 'me-2' : ''}">
                                    <div class="${bubbleClass} p-2 rounded">
                                        <p class="mb-0 small">${content}</p>
                                        ${metadata.confidence ? `<div class="mt-1"><span class="badge bg-secondary">Confidence: ${Math.round(metadata.confidence * 100)}%</span></div>` : ''}
                                        ${metadata.suggested_actions && metadata.suggested_actions.length > 0 ? 
                                            `<div class="mt-2">
                                                <small class="text-muted">Suggestions:</small><br>
                                                ${metadata.suggested_actions.map(action => `<span class="badge bg-info me-1">${action}</span>`).join('')}
                                            </div>` : ''}
                                        ${metadata.error ? `<div class="mt-1"><span class="badge bg-danger">Error</span></div>` : ''}
                                    </div>
                                    <small class="text-muted">${timestamp}</small>
                                </div>
                                ${isUser ? `<div class="avatar ${avatarBg} text-white rounded-circle d-flex align-items-center justify-content-center ms-2" style="width: 32px; height: 32px; font-size: 12px;">
                                    ${avatarText}
                                </div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                chatMessages.insertAdjacentHTML('beforeend', messageHtml);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                console.log('ğŸ’¬ [CHAT] Message added:', { role, content: content.substring(0, 50) + '...', metadata });
            }
            
            getChatHistory() {
                // RÃ©cupÃ©rer l'historique des messages du DOM
                const messages = [];
                const messageElements = document.querySelectorAll('#chat-messages .message');
                
                messageElements.forEach(element => {
                    const role = element.classList.contains('assistant') ? 'assistant' : 'user';
                    const content = element.querySelector('.message-content p')?.textContent || '';
                    const timestamp = element.querySelector('small')?.textContent || new Date().toISOString();
                    
                    if (content.trim()) {
                        messages.push({
                            role: role,
                            content: content,
                            timestamp: timestamp,
                            metadata: {}
                        });
                    }
                });
                
                console.log('ğŸ“ [CHAT] Chat history retrieved:', messages.length, 'messages');
                return messages.slice(-10); // Garder seulement les 10 derniers messages pour le contexte
            }
            
            setupSlideInteractionButtons() {
                const simplifyBtn = document.getElementById('simplify-btn');
                const moreDetailsBtn = document.getElementById('more-details-btn');
                
                if (simplifyBtn) {
                    simplifyBtn.addEventListener('click', () => this.simplifySlideContent());
                    console.log('âœ… [BUTTONS] Simplify button event listener added');
                } else {
                    console.warn('âš ï¸ [BUTTONS] Simplify button not found');
                }
                
                if (moreDetailsBtn) {
                    moreDetailsBtn.addEventListener('click', () => this.moreDetailsSlideContent());
                    console.log('âœ… [BUTTONS] More Details button event listener added');
                } else {
                    console.warn('âš ï¸ [BUTTONS] More Details button not found');
                }
            }
            
            async simplifySlideContent() {
                const simplifyBtn = document.getElementById('simplify-btn');
                const slideContentEl = document.getElementById('slide-content');
                
                if (!slideContentEl) {
                    console.error('âŒ [SIMPLIFY] Slide content element not found');
                    return;
                }
                
                try {
                    console.log('ğŸ¯ [SIMPLIFY] Starting slide content simplification');
                    
                    // DÃ©sactiver le bouton pendant le traitement
                    if (simplifyBtn) {
                        simplifyBtn.disabled = true;
                        simplifyBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Simplifying...';
                    }
                    
                    // Obtenir le contenu markdown actuel
                    const currentMarkdown = this.getCurrentSlideMarkdown();
                    if (!currentMarkdown) {
                        console.error('âŒ [SIMPLIFY] No current slide content to simplify');
                        return;
                    }
                    
                    console.log('ğŸ“ [SIMPLIFY] Current content length:', currentMarkdown.length);
                    console.log('ğŸ“ [SIMPLIFY] Current content preview:', currentMarkdown.substring(0, 100) + '...');
                    
                    // Appeler l'API de simplification
                    const response = await fetch(`/api/slides/simplify/${this.learnerSession.id}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            current_content: currentMarkdown
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API request failed: ${response.status} ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    console.log('âœ… [SIMPLIFY] API response received:', result);
                    
                    if (result.success && result.data.simplified_content) {
                        // Remplacer le contenu de la slide avec la version simplifiÃ©e
                        const simplifiedContent = result.data.simplified_content;
                        console.log('ğŸ“ [SIMPLIFY] Simplified content length:', simplifiedContent.length);
                        console.log('ğŸ“ [SIMPLIFY] Simplified content preview:', simplifiedContent.substring(0, 100) + '...');
                        
                        // Mettre Ã  jour l'affichage
                        slideContentEl.innerHTML = this.markdownToHtml(simplifiedContent);
                        
                        // Sauvegarder le nouveau contenu pour usage futur
                        this.currentSlideContent = simplifiedContent;
                        
                        console.log('âœ… [SIMPLIFY] Slide content simplified successfully');
                        
                        // Afficher un message de succÃ¨s temporaire
                        this.showSimplifySuccess(result.data);
                        
                    } else {
                        throw new Error('Invalid API response structure');
                    }
                    
                } catch (error) {
                    console.error('âŒ [SIMPLIFY] Error simplifying slide content:', error);
                    
                    // Afficher une erreur Ã  l'utilisateur
                    this.showSimplifyError(error.message);
                    
                } finally {
                    // RÃ©activer le bouton
                    if (simplifyBtn) {
                        simplifyBtn.disabled = false;
                        simplifyBtn.innerHTML = '<i class="bi bi-lightbulb me-1"></i>Simplify';
                    }
                }
            }
            
            getCurrentSlideMarkdown() {
                // Pour l'instant, nous devons reconstruire le markdown Ã  partir du HTML affichÃ©
                // Dans une implÃ©mentation future, nous pourrions stocker le markdown original
                return this.currentSlideContent || 'No slide content available';
            }
            
            showSimplifySuccess(data) {
                const alertHtml = `
                    <div class="alert alert-success alert-dismissible fade show mt-2" role="alert">
                        <i class="bi bi-check-circle me-2"></i>
                        <strong>Content Simplified!</strong> 
                        Reduced from ${data.original_length} to ${data.simplified_length} characters.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                
                const slideContentEl = document.getElementById('slide-content');
                if (slideContentEl) {
                    slideContentEl.insertAdjacentHTML('afterend', alertHtml);
                    
                    // Supprimer l'alerte aprÃ¨s 5 secondes
                    setTimeout(() => {
                        const alert = document.querySelector('.alert-success');
                        if (alert) alert.remove();
                    }, 5000);
                }
            }
            
            showSimplifyError(errorMessage) {
                const alertHtml = `
                    <div class="alert alert-warning alert-dismissible fade show mt-2" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Simplification Failed:</strong> ${errorMessage}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                
                const slideContentEl = document.getElementById('slide-content');
                if (slideContentEl) {
                    slideContentEl.insertAdjacentHTML('afterend', alertHtml);
                    
                    // Supprimer l'alerte aprÃ¨s 8 secondes
                    setTimeout(() => {
                        const alert = document.querySelector('.alert-warning');
                        if (alert) alert.remove();
                    }, 8000);
                }
            }
            
            async moreDetailsSlideContent() {
                const moreDetailsBtn = document.getElementById('more-details-btn');
                const slideContentEl = document.getElementById('slide-content');
                
                if (!slideContentEl) {
                    console.error('âŒ [MORE_DETAILS] Slide content element not found');
                    return;
                }
                
                try {
                    console.log('ğŸ¯ [MORE_DETAILS] Starting slide content enhancement');
                    
                    // DÃ©sactiver le bouton pendant le traitement
                    if (moreDetailsBtn) {
                        moreDetailsBtn.disabled = true;
                        moreDetailsBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Adding Details...';
                    }
                    
                    // Obtenir le contenu markdown actuel
                    const currentMarkdown = this.getCurrentSlideMarkdown();
                    if (!currentMarkdown) {
                        console.error('âŒ [MORE_DETAILS] No current slide content to enhance');
                        return;
                    }
                    
                    console.log('ğŸ“ [MORE_DETAILS] Current content length:', currentMarkdown.length);
                    console.log('ğŸ“ [MORE_DETAILS] Current content preview:', currentMarkdown.substring(0, 100) + '...');
                    
                    // Appeler l'API d'approfondissement
                    const response = await fetch(`/api/slides/more-details/${this.learnerSession.id}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            current_content: currentMarkdown
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API request failed: ${response.status} ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    console.log('âœ… [MORE_DETAILS] API response received:', result);
                    
                    if (result.success && result.data.detailed_content) {
                        // Remplacer le contenu de la slide avec la version approfondie
                        const detailedContent = result.data.detailed_content;
                        console.log('ğŸ“ [MORE_DETAILS] Enhanced content length:', detailedContent.length);
                        console.log('ğŸ“ [MORE_DETAILS] Enhanced content preview:', detailedContent.substring(0, 100) + '...');
                        
                        // Mettre Ã  jour l'affichage
                        slideContentEl.innerHTML = this.markdownToHtml(detailedContent);
                        
                        // Sauvegarder le nouveau contenu pour usage futur
                        this.currentSlideContent = detailedContent;
                        
                        console.log('âœ… [MORE_DETAILS] Slide content enhanced successfully');
                        
                        // Afficher un message de succÃ¨s temporaire
                        this.showMoreDetailsSuccess(result.data);
                        
                    } else {
                        throw new Error('Invalid API response structure');
                    }
                    
                } catch (error) {
                    console.error('âŒ [MORE_DETAILS] Error enhancing slide content:', error);
                    
                    // Afficher une erreur Ã  l'utilisateur
                    this.showMoreDetailsError(error.message);
                    
                } finally {
                    // RÃ©activer le bouton
                    if (moreDetailsBtn) {
                        moreDetailsBtn.disabled = false;
                        moreDetailsBtn.innerHTML = '<i class="bi bi-plus-circle me-1"></i>More Details';
                    }
                }
            }
            
            showMoreDetailsSuccess(data) {
                const alertHtml = `
                    <div class="alert alert-info alert-dismissible fade show mt-2" role="alert">
                        <i class="bi bi-plus-circle me-2"></i>
                        <strong>Content Enhanced!</strong> 
                        Expanded from ${data.original_length} to ${data.detailed_length} characters with more technical details.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                
                const slideContentEl = document.getElementById('slide-content');
                if (slideContentEl) {
                    slideContentEl.insertAdjacentHTML('afterend', alertHtml);
                    
                    // Supprimer l'alerte aprÃ¨s 5 secondes
                    setTimeout(() => {
                        const alert = document.querySelector('.alert-info');
                        if (alert) alert.remove();
                    }, 5000);
                }
            }
            
            showMoreDetailsError(errorMessage) {
                const alertHtml = `
                    <div class="alert alert-warning alert-dismissible fade show mt-2" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Enhancement Failed:</strong> ${errorMessage}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                
                const slideContentEl = document.getElementById('slide-content');
                if (slideContentEl) {
                    slideContentEl.insertAdjacentHTML('afterend', alertHtml);
                    
                    // Supprimer l'alerte aprÃ¨s 8 secondes
                    setTimeout(() => {
                        const alert = document.querySelector('.alert-warning');
                        if (alert) alert.remove();
                    }, 8000);
                }
            }
            
            showError(message) {
                this.container.innerHTML = `
                    <div class="row">
                        <div class="col-12">
                            <div class="alert alert-danger" role="alert">
                                <h4 class="alert-heading">
                                    <i class="bi bi-exclamation-triangle me-2"></i>Error
                                </h4>
                                <p>${message}</p>
                                <hr>
                                <div class="mb-0">
                                    <button class="btn btn-outline-danger" onclick="location.reload()">
                                        <i class="bi bi-arrow-clockwise me-1"></i>Retry
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="history.back()">
                                        <i class="bi bi-arrow-left me-1"></i>Go Back
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        // Initialize the application when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸŒŸ Training page loaded, initializing app...');
            new TrainingApp();
        });
    </script>
</body>
</html>